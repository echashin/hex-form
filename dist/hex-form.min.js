var HexWidget=function(){"use strict";function e(e){return null===e||e===!1||void 0===e||""===e||$.isArray(e)&&0===e.length?!0:!1}function t(e){function t(e){void 0!==e.input&&(n=e.input,a=n.closest(".form-group").find("button.password-show"),a.bind("click",function(e){return e.preventDefault(),"password"===r?(n.attr("type","text"),a.addClass("active"),r="text"):(n.attr("type","password"),a.removeClass("active"),r="password"),n.focus(),!1}))}var a,n,r="password";t(e)}function a(e){function t(e){return s=e.length>8?1:0,u=e.match(f)?1:0,d=e.match(v)?1:0,l=e.match(p)?1:0,c=e.match(h)?1:0,s+u+d+l+c}function a(e){void 0!==e.events&&i.setEvents(e.events),void 0!==e.input&&(n=e.input,r=n.closest(".form-group").find(".password-strength div"),n.bind("keyup change",function(){var e=n.val();r.attr("class","s-"+t(e))}))}var n,r,i=this,o=["change"],s=0,u=0,d=0,l=0,c=0,f=new RegExp("[A-ZА-Я]"),v=new RegExp("[a-zа-я]"),p=new RegExp("[0-9]"),h=new RegExp("([!,%,&,@,#,$,^,*,?,_,~])");i.weight=0,i.setEvents=function(e){o=e},i.getEvents=function(){return o},a(e)}function n(e){function t(e){if(void 0!==e.input){a=e.input;var t=moment.localeData(),n=t.longDateFormat("L");void 0!==e.timePicker&&e.timePicker===!0&&(n+=" "+t.longDateFormat("LT"));var r={autoUpdateInput:!1,linkedCalendars:!1,singleDatePicker:!0,locale:{format:n,separator:" - ",applyLabel:"Готово",cancelLabel:"Отмена",fromLabel:"От",toLabel:"До",customRangeLabel:"Custom",daysOfWeek:moment.weekdaysShort(),monthNames:moment.months(),firstDay:t.firstDayOfWeek()}};$.extend(r,e);var i=r.locale.format.replace(/[H]/g,"9").replace(/[m]/g,"9").replace(/[D]+/g,"d").replace(/[M]+/g,"m").replace(/[Y]+/g,"y");r.singleDatePicker===!1&&(i+=r.locale.separator+i),a.inputmask(i),a.daterangepicker(r),a.on("apply.daterangepicker",function(e,t){var n=t.startDate.format(r.locale.format);r.singleDatePicker===!1&&(n+=r.locale.separator+t.endDate.format(r.locale.format)),a.val(n),a.trigger("keyup")})}}var a;t(e)}function r(t){function a(t){if(void 0!==t.control&&(r=t.control),void 0!==t.input){n=t.input;var a=t.placeholder||"",o={theme:"bootstrap",allowClear:!0,placeholder:a};if(void 0!==t.url){i="ajax";var s=n.find("option[selected]");if(t.ajax={url:t.url,method:"POST",dataType:"json",delay:250,data:function(e){return{search:e.term,page:e.page}},processResults:function(e,t){return t.page=t.page||1,{results:e.rows,pagination:{more:t.page*e.limit<e.total}}},cache:!1},delete t.url,void 0!==t.parent){var u=t.parent.selector,d=t.parent.param||"parent_id";e($(u).val())&&(r.disable(),n.val("").trigger("change")),$(u).on("change",function(){e($(this).val())?(r.disable(),n.val("").trigger("change")):r.enable()}),delete t.parent;var l=function(){return $(u).val()};t.ajax.data=function(e){var t={search:e.term,page:e.page};return t[d]=l,t}}}$.extend(o,t),n.select2(o),"ajax"===i&&(s.each(function(){n.append($(this))}),n.trigger("change"))}}var n,r,i="local";a(t)}function i(e){function t(e){function t(e){r=e.target.files[0],n.setValue(r)}a=e.input,n=e.control,a.bind("change",t)}var a,n,r;t(e)}function o(e){function t(e){a=e.input,a.inputmask(e.mask)}var a;t(e)}function s(e){function t(e){void 0!==e.input&&(a=e.input,a.inputmask("+7(999)999-99-99"))}var a;t(e)}function u(e){function u(e){switch(e.type){case"password-strength":return new a(e);case"password-show":return new t(e);case"date":return new n(e);case"phone":return new s(e);case"select2":return new r(e);case"mask":return new o(e);case"filesimple":return new i(e);default:throw new Error("Unfinded widget: "+e.type)}}return u(e)}return u}(),HexValidator=function(){"use strict";function e(e){function t(e){void 0!==e.events&&a.setEvents(e.events)}var a=this,n=["blur","change"];a.weight=0;var r="required";a.getClassName=function(){return r},a.setEvents=function(e){n=e},a.getEvents=function(){return n},a.isValid=function(e){return null===e||e===!1||void 0===e||""===e||$.isArray(e)&&0===e.length?!1:!0},t(e)}function t(e){function t(e){void 0!==e.events&&a.setEvents(e.events),void 0!==e.input&&(r=e.input)}var a=this,n=["change","keyup","blur"];a.weight=3;var r,i="date";a.getClassName=function(){return i},a.setEvents=function(e){n=e},a.getEvents=function(){return n},a.isValid=function(e){if(""===e||void 0===e||e===!1)return!0;var t=r.inputmask("option","mask");return Inputmask.isValid(r.val(),{alias:t})},t(e)}function a(e){function t(e){void 0!==e.events&&a.setEvents(e.events)}var a=this,n="email";a.getClassName=function(){return n};var r=["change","keyup"],i=/^\S+[@]\S+\.\S{2,10}$/i;a.weight=1,a.setEvents=function(e){r=e},a.getEvents=function(){return r},a.isValid=function(e){return""===e||void 0===e||e===!1?!0:i.test(e)},t(e)}function n(e){function t(e){void 0!==e.events&&a.setEvents(e.events),void 0!==e.url&&(r=e.url)}var a=this,n="unique";a.getClassName=function(){return n};var r,i=!1,o=!1,s=["change","keyup","blur"];a.weight=5,a.setEvents=function(e){s=e},a.getEvents=function(){return s},a.isValid=function(e){if(o!==!1&&o.abort(),i!==e){o=$.ajax({url:r,data:{value:e},method:"POST",async:!1});var t=o.responseText;return i="true"===t?e:!1,t}return!0},t(e)}function r(e){function t(e){void 0!==e.events&&n.setEvents(e.events),void 0!==e.input&&(a=e.input)}var a,n=this,r="phone",i=["blur"];n.getClassName=function(){return r},n.weight=4,n.setEvents=function(e){i=e},n.getEvents=function(){return i},n.isValid=function(e){if(""===e||void 0===e||e===!1||null===e)return!0;var t=a.inputmask("option","mask");return Inputmask.isValid(a.val(),{alias:t})},t(e)}function i(e){function t(e){void 0!==e.events&&n.setEvents(e.events),void 0!==e.input&&(a=e.input)}var a,n=this,r="mask",i=["blur"];n.getClassName=function(){return r},n.weight=4,n.setEvents=function(e){i=e},n.getEvents=function(){return i},n.isValid=function(e){if(""===e||void 0===e||e===!1||null===e)return!0;var t=a.inputmask("option","mask");return Inputmask.isValid(a.val(),{alias:t})},t(e)}function o(e){function t(e){void 0!==e.min&&(a=e.min),void 0!==e.max&&(n=e.max),void 0!==e.events&&r.setEvents(e.events)}var a,n,r=this,i="string-length";r.getClassName=function(){return i};var o=["change","keyup","blur"];r.weight=3,r.setEvents=function(e){o=e},r.getEvents=function(){return o},r.isValid=function(e){var t=e.length;return void 0!==a&&a>t?(i="string-length-min",!1):void 0!==n&&t>n?(i="string-length-max",!1):!0},t(e)}function s(e){function t(e){void 0!==e.events&&a.setEvents(e.events),void 0!==e.password&&(i=$(e.password))}var a=this,n="password-confirm";a.getClassName=function(){return n};var r=["change","keyup","blur"];a.weight=4;var i;a.setEvents=function(e){r=e},a.getEvents=function(){return r},a.isValid=function(e){return i.val()===e},t(e)}function u(u){function d(u){switch(u.type){case"required":return new e(u);case"email":return new a(u);case"unique":return new n(u);case"password-confirm":return new s(u);case"string-length":return new o(u);case"date":return new t(u);case"phone":return new r(u);case"mask":return new i(u);default:throw new Error("Unfinded validator: "+u.type)}}return d(u)}return u}(),hexForm=function(e,t){"use strict";function a(e){function t(e){return function(t,a){return"number"==typeof t[e]?t[e]-a[e]:t[e]<a[e]?-1:t[e]>a[e]?1:0}}var a=this;a.type=void 0,a.valid=!0,a.name=void 0;var n,r,i=[],o=e.form;a.formGroup=void 0,a.panels=[],a.tabs=[];var s,u=[],d={},l={};a.disabled=!1,a.readonly=!1,a.setValid=function(){a.formGroup.removeClass("has-error"),n.find("span").removeClass("active")},a.enable=function(){for(var e in i)i[e].prop("disabled",!1);a.disabled=!1},a.disable=function(){for(var e in i)i[e].prop("disabled",!0);a.disabled=!0,a.valid=!0,a.validate()},a.addReadonly=function(){for(var e in i)i[e].prop("readonly",!0);a.readonly=!0},a.removeReadonly=function(){for(var e in i)i[e].prop("readonly",!1);a.readonly=!1};var c=function(){var e=0;if(n.find("span").removeClass("active"),!a.disabled)for(var t in u)if(u.hasOwnProperty(t)){var r=u[t],i=a.getValue(),s=r.isValid(i);if(s===!1||"false"===s){e++,n.find("span.error-"+r.getClassName()).addClass("active");break}}if(e>0?(a.valid=!1,a.formGroup.addClass("has-error")):(a.formGroup.removeClass("has-error"),a.valid=!0),a.panels.length>0){var d=!0;if(a.valid===!0){for(var l in o.controls)if(o.controls.hasOwnProperty(l)){var c=o.controls[l];if(c.valid===!1)for(var f in c.panels){var v=c.panels[f];for(var p in a.panels)if(v===a.panels[p]){d=!1;break}}}}else d=!1;d===!0?$.each(a.tabs,function(e,t){t.removeClass("has-error")}):$.each(a.tabs,function(e,t){t.addClass("has-error")})}return a.valid};a.validate=function(e){return void 0===e?c():"blur"===e.type?c():(void 0!==r&&clearTimeout(r),void(r=setTimeout(c,500)))},a.trigger=function(e){for(var t=0;t<i.length;t++)i[t].trigger(e)},a.addEvent=function(e,t){for(var a=0;a<i.length;a++)i[a].bind(e,t)};var f=function(e){for(var t={},a=e[0].attributes,n=a.length,r=0;n>r;r++)t[a[r].name.toLowerCase()]=a[r].value;return t},v=function(e,t,a){var n={input:a,type:e};void 0!==t&&""!==t&&$.extend(n,jQuery.parseJSON(t));var r=new HexValidator(n),i=r.getEvents();for(var o in i)i.hasOwnProperty(o)&&(l[i[o]]=!0);u.push(r)},p=function(e,t,n){var r={input:n,type:e,control:a};void 0!==t&&""!==t&&$.extend(r,jQuery.parseJSON(t)),d[e]=new HexWidget(r)};a.addInput=function(e){i.push(e);var n=f(e);for(var r in n)if(n.hasOwnProperty(r)){if("required"===r)v("required",n[r],e);else{var o=r.match(/^data-hex-validator-(.*)$/i);null!==o&&void 0!==o[1]&&v(o[1],n[r],e)}var s=r.match(/^data-hex-widget-(.*)$/i);null!==s&&void 0!==s[1]&&p(s[1],n[r],e)}for(var d in l)l.hasOwnProperty(d)&&e.bind(d,a.validate);u.sort(t("weight")),e.prop("disabled")&&a.disable(),e.prop("readonly")&&a.addReadonly(),e.bind("disable",function(){a.disable()}),e.bind("enable",function(){a.enable()})},a.getValue=function(){switch(a.type){case"text":default:if(void 0!==d.date){var e=i[0].data("daterangepicker");if(void 0===e)return i[0].val();if(""===i[0].val())return!1;var t="",n="YYYY-MM-DD";if(e.timePicker===!0&&(n+=" HH:mm"),t+=e.startDate.format(n),e.singleDatePicker===!1){var r=e.endDate.format(n);t+=" - "+r}return t}return void 0!==d.fileupload||void 0!==d.filesimple?s:i[0].val();case"radio":for(var o in i)if(i.hasOwnProperty(o)&&i[o].is(":checked")===!0)return i[o].val();return!1;case"checkbox":return i[0].is(":checked")===!0?a.trueValue:a.falseValue}},a.setValue=function(e){s=e};var h=function(e){if(void 0!==e.type&&(a.type=e.type,"checkbox"===e.type&&(a.trueValue=!0,a.falseValue=!1)),void 0!==e.form&&(o=e.form),a.name=e.name,void 0!==e.inputs)for(var t in e.inputs)e.inputs.hasOwnProperty(t)&&a.addInput(e.inputs[t]);if(a.formGroup=i[0].closest("div.form-group"),n=a.formGroup.find(".errors"),0==n.size)throw new Error('Errors block not found near control "'+a.name+'" ');a.formGroup.parents('[role="tabpanel"]').size()>0&&a.formGroup.parents('[role="tabpanel"]').each(function(){var e=$(this),t=e.attr("id");a.panels.push(t);var n=$('.nav a[href="#'+t+'"]');n.size()>0&&a.tabs.push(n)}),a.setValid()};h(e)}function n(n){function r(e){function t(){r.getValue()!==n?(e.hide(),e.find('input[type!="submit"],select,textarea').trigger("disable")):(e.show(),e.find('input[type!="submit"],select,textarea').trigger("enable"))}if(e.parents('[data-hex-multy-item="$"]').size()>0)return!1;var a=e.data("hexDisabled"),n=a.value,r=u.controls[a.control];if(void 0===r)throw new Error('Control "'+a.control+'" not found');r.addEvent("change",t),r.trigger("change")}function i(e){return e.replace("-","").toUpperCase()}function o(e,t){function a(e){var t=e.split(""),a=[],n=[],r=0,i=!0;a[r]="";for(var o=0;o<t.length;o++)isNaN(parseInt(t[o]))&&"."!==t[o]&&!i?(n[r]=t[o],r++,a[r]="",i=!0):(a[r]+=t[o],i=!1);e=parseFloat(a[0]);for(var s=0;s<n.length;s++){var u=parseFloat(a[s+1]);switch(n[s]){case"+":e+=u;break;case"-":e-=u;break;case"*":e*=u;break;case"/":e/=u}}return e}function n(e){if("object"==typeof e)for(var r in e)e[r]=n(e[r]);else{for(var i in t)e=e.replace(new RegExp(i,"g"),t[i]);/\%/.test(e)&&(e=e.replace(/\%(.*?)\%/g,function(e){return a(e.replace(/\%/g,""))}))}return e}var r=[];r.push(e),e.find("[data-hex-bind]").each(function(){r.push($(this))});for(var o in r){var s=r[o].data("hexBind");for(var d in s){var l=n(s[d]);if("html"!==d){if(/^data/.test(d)){var c=d.replace(/^data-/,"");c=c.replace(/(\-[a-z])/g,i),r[o].data(c,l)}if("name"===d){var f=r[o].attr("name");if(void 0!==f&&void 0!==u.controls[f]){var v=u.controls[f];v.name=l,u.controls[l]=v,delete u.controls[f]}}"object"==typeof l?r[o].attr(d,JSON.stringify(l)):r[o].attr(d,l)}else r[o].html(l)}}}function s(e){function t(e,t){o(e,{"@index":t})}function a(){if(u===!1){var t=e.find("[data-hex-multy-item]");t.size()<=1?e.find("[data-hex-multy-remove]").attr("disabled","disabled"):e.find("[data-hex-multy-remove]").removeAttr("disabled")}}var n,i,s=e.data("hex-multy"),u=!1;void 0!==s.allow_empty&&s.allow_empty===!0&&(u=!0),e.find("[data-hex-multy-tabs]").size()>0&&(n=e.find("[data-hex-multy-tabs]"),i=n.find('[data-hex-multy-tab="$"]').clone(!1),n.find('[data-hex-multy-tab="$"]').remove());var d=e.find('[data-hex-multy-item="$"]'),l=d.clone(!1);d.remove(),e.on("click","[data-hex-multy-add]",function(){var o=$(this).closest("[data-hex-multy]").find("[data-hex-multy-item]"),s=o.size(),u=l.clone(!1);if(u.find("[data-hex-multy-hide]").remove(),u.find("[data-hex-multy-attr]").each(function(){var e=$(this),t=e.data("hex-multy-attr");if(void 0!==t.add&&$.each(t.add,function(t,a){for(var n in a)e.attr(n,a[n])}),void 0!==t.remove)for(var a in t.remove)e.removeAttr(t.remove[a])}),t(u,s),u.appendTo(e.find("[data-hex-multy-items]")),void 0!==n){var d=i.clone(!1);t(d,s),e.find("[data-hex-multy-tab]:last").size()>0?d.insertAfter(e.find("[data-hex-multy-tab]:last")):n.prepend(d)}p(u),void 0!==n&&$('a[href="#'+u.attr("id")+'"]').trigger("click"),u.find("[data-hex-disabled]").size()>0&&u.find("[data-hex-disabled]").each(function(){r($(this))}),a()}),e.on("click","[data-hex-multy-remove]",function(){var r=$(this).closest("[data-hex-multy-item]"),i=r.data("hexMultyItem"),o=e.find("[data-hex-multy-item]");v(r),r.fadeOut(500,function(){r.remove(),o.each(function(){$(this).data("hexMultyItem")>i&&t($(this),$(this).data("hexMultyItem")-1)}),void 0!==n&&(n.find('[data-hex-multy-tab="'+i+'"]').remove(),n.find("[data-hex-multy-tab]").each(function(){$(this).data("hexMultyTab")>i&&t($(this),$(this).data("hexMultyTab")-1)}),n.find("[data-hex-multy-tab="+i+"]").size()>0?n.find("[data-hex-multy-tab="+i+"]").find('a[role="tab"]').trigger("click"):n.find("[data-hex-multy-tab]:nth-child("+i+")").size()>0&&n.find("[data-hex-multy-tab]:nth-child("+i+")").find('a[role="tab"]').trigger("click")),a()})}),a()}var u=this;u.controls={},u.errorText="Не удалось сохранить форму, попробуйте обновить страницу";var d=n,l=d.attr("id"),c={},f=function(e){this.type=e,this.stoped=!1,this.stop=function(){this.stoped=!0}};u.on=function(e,t){void 0===c[e]&&(c[e]=[]),c[e].push(t)},u.off=function(e,t){void 0!==c[e]&&c[e].splice(c[e].indexOf(t),1)},u.fire=function(e,t){var a=new f(e);if(void 0!==c[e])for(var n in c[e]){var r=c[e][n];r(t,a)}return!a.stoped};var v=function(e){$.each(e.find('input[type!="submit"],select,textarea'),function(e,t){var a=$(t),n=a.attr("name");void 0!==u.controls[n]&&delete u.controls[n]})},p=function(e){$.each(e.find('input[type!="submit"],select,textarea'),function(e,t){var n=$(t);if(0===n.parents('[data-hex-multy-item="$"]').size()){var r=n.attr("name"),i=n.prop("tagName").toLowerCase();switch(i){case"select":case"textarea":u.controls[r]=new a({type:i,inputs:[n],form:u,name:r});break;case"input":var o=n.attr("type").toLowerCase();switch(o){default:u.controls[r]=new a({type:o,inputs:[n],form:u,name:r});break;case"checkbox":var s=new a({type:"checkbox",inputs:[n],form:u,name:r});void 0!==n.attr("value")&&(s.trueValue=n.attr("value")),void 0!==n.attr("data-hex-true-value")&&(s.trueValue=n.attr("data-hex-true-value")),void 0!==n.attr("data-hex-false-value")&&(s.falseValue=n.attr("data-hex-false-value")),u.controls[r]=s;break;case"radio":void 0===u.controls[r]?u.controls[r]=new a({type:"radio",inputs:[n],form:u,name:r}):u.controls[r].addInput(n)}}}})},h=function(){var e={};for(var t in u.controls)if(u.controls.hasOwnProperty(t)&&u.controls[t].disabled===!1){var a=u.controls[t].name,n=u.controls[t].getValue();null===n||$.isArray(n)&&0===n.length?n="":e[a]=n}return e},m=function(t){var a=u.fire("beforeReset",{values:u.getValues()});a?e.setTimeout(function(){for(var e in u.controls)u.controls.hasOwnProperty(e)&&u.controls[e].trigger("change")},1):t.preventDefault(),u.fire("afterReset",{})},g=function(){d.find(".has-error").removeClass("has-error"),d.find(".alerts div").remove()},y=function(t){t.preventDefault(),t.stopPropagation();var a=!0;for(var n in u.controls)u.controls.hasOwnProperty(n)&&u.controls[n].validate(void 0)===!1&&(a=!1);if(a===!0){g();var r=h(),i=u.fire("beforeSubmit",{values:r});if(i){u.loaderShow();var o=d.attr("action"),s=d.find("button[type=submit]:focus");s.size()>0&&void 0!==s.attr("data-action")&&(o=s.attr("data-action"));var l="POST";void 0!==d.attr("method")&&(l=d.attr("method"));var c=new FormData;$.each(r,function(e,t){if($.isArray(t)||$.isPlainObject(t))for(var a in t)null!==t[a]&&t[a]!==!1&&void 0!==t[a]&&c.append(e,t[a]);else c.append(e,t)}),$.ajax({url:o,data:c,type:l,dataType:"json",processData:!1,contentType:!1,success:function(t){if(t.success===!0?(g(),void 0!==t.reload?t.reload===!0?e.location.href=e.location.href:e.location.href=t.reload:u.loaderHide()):u.loaderHide(),void 0!==t.alerts){for(var a in t.alerts){var n=t.alerts[a];d.find(".alerts").append($("<div>").addClass("alert alert-"+n.type).html(n.text))}u.loaderHide()}},error:function(e,t){u.loaderHide(),d.find(".alerts").append($("<div>").addClass("alert alert-danger").html(u.errorText))}})}}return!1};u.loaderShow=function(){d.find(".loader").show()},u.loaderHide=function(){d.find(".loader").hide()},u.submit=function(){y()},u.getValues=function(){return h()};var b=function(){d.addClass("loader-container").append('<div class="loader"></div>'),$(t).on("submit","#"+l,y),$(t).on("reset","#"+l,m),0===d.find(".loader").size()&&d.append('<div class="loader"></div>'),p(d),d.find("[data-hex-multy]").size()>0&&d.find("[data-hex-multy]").each(function(){s($(this))}),d.find("[data-hex-disabled]").size()>0&&d.find("[data-hex-disabled]").each(function(){r($(this))})};return b(),u}function r(e){if(void 0!==e)return void 0===i[e]&&(i[e]=new n($("#"+e))),i[e];var t=$("form.hex-form");return t.each(function(){var e=$(this).attr("id");if(void 0===e)throw new Error("Form dont have id attr");i[e]=new n($(this))}),i}var i={};return r}(window,document);