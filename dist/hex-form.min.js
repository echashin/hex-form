var HexWidget=function(){"use strict";function e(e){return null===e||e===!1||void 0===e||""===e||$.isArray(e)&&0===e.length?!0:!1}function t(e){function t(e){void 0!==e.input&&(n=e.input,a=n.closest(".form-group").find("button.password-show"),a.bind("click",function(e){return e.preventDefault(),"password"===r?(n.attr("type","text"),a.addClass("active"),r="text"):(n.attr("type","password"),a.removeClass("active"),r="password"),n.focus(),!1}))}var a,n,r="password";t(e)}function a(e){function t(e){return s=e.length>8?1:0,d=e.match(f)?1:0,l=e.match(v)?1:0,u=e.match(p)?1:0,c=e.match(h)?1:0,s+d+l+u+c}function a(e){void 0!==e.events&&i.setEvents(e.events),void 0!==e.input&&(n=e.input,r=n.closest(".form-group").find(".password-strength div"),n.bind("keyup change",function(){var e=n.val();r.attr("class","s-"+t(e))}))}var n,r,i=this,o=["change"],s=0,d=0,l=0,u=0,c=0,f=new RegExp("[A-ZА-Я]"),v=new RegExp("[a-zа-я]"),p=new RegExp("[0-9]"),h=new RegExp("([!,%,&,@,#,$,^,*,?,_,~])");i.weight=0,i.setEvents=function(e){o=e},i.getEvents=function(){return o},a(e)}function n(t){function a(t){if(void 0!==t.input){n=t.input,delete t.input,r=t.control,delete t.control;var a=moment.localeData(),i=a.longDateFormat("L");void 0!==t.timePicker&&t.timePicker===!0&&(i+=" "+a.longDateFormat("LT"));var o={autoUpdateInput:!1,linkedCalendars:!1,singleDatePicker:!0,locale:{format:i,separator:" - ",applyLabel:"Готово",cancelLabel:"Отмена",fromLabel:"От",toLabel:"До",customRangeLabel:"Custom",daysOfWeek:moment.weekdaysShort(),monthNames:moment.months(),firstDay:a.firstDayOfWeek()}};$.extend(o,t);var s=o.locale.format.replace(/[H]/g,"9").replace(/[m]/g,"9").replace(/[D]+/g,"d").replace(/[M]+/g,"m").replace(/[Y]+/g,"y");if(o.singleDatePicker===!1&&(s+=o.locale.separator+s),n.inputmask(s),n.daterangepicker(o),n.on("apply.daterangepicker",function(e,t){var a=t.startDate.format(o.locale.format);o.singleDatePicker===!1&&(a+=o.locale.separator+t.endDate.format(o.locale.format)),n.val(a),n.trigger("change")}),void 0!==t.parent){var d=t.parent;$(d).on("change",function(){var t=$(d).val();e(t)?(r.disable(),n.val("").trigger("change")):(o.minDate=t,n.daterangepicker(o),n.on("apply.daterangepicker",function(e,t){var a=t.startDate.format(o.locale.format);o.singleDatePicker===!1&&(a+=o.locale.separator+t.endDate.format(o.locale.format)),n.val(a),n.trigger("change")}),r.enable(),n.data(o))})}}}var n,r;a(t)}function r(t){function a(t){if(void 0!==t.control&&(r=t.control),void 0!==t.input){n=t.input;var a=t.placeholder||"",o={theme:"bootstrap",allowClear:!0,placeholder:a};if(void 0!==t.url){i="ajax";var s=n.find("option[selected]");if(t.ajax={url:t.url,method:"POST",dataType:"json",delay:250,data:function(e){return{search:e.term,page:e.page}},processResults:function(e,t){return t.page=t.page||1,{results:e.rows,pagination:{more:t.page*e.limit<e.total}}},cache:!1},delete t.url,void 0!==t.parent){var d=t.parent.selector,l=t.parent.param||"parent_id";e($(d).val())&&(r.disable(),n.val("").trigger("change")),$(d).on("change",function(){e($(this).val())?(r.disable(),n.val("").trigger("change")):r.enable()}),delete t.parent;var u=function(){return $(d).val()};t.ajax.data=function(e){var t={search:e.term,page:e.page};return t[l]=u,t}}}$.extend(o,t),n.select2(o),"ajax"===i&&(s.each(function(){n.append($(this))}),n.trigger("change"))}}var n,r,i="local";a(t)}function i(e){function t(e){function t(e){r=e.target.files[0],n.setValue(r)}a=e.input,n=e.control,a.bind("change",t)}var a,n,r;t(e)}function o(e){function t(e){a=e.input,a.inputmask(e.mask)}var a;t(e)}function s(e){function t(e){void 0!==e.input&&(a=e.input,a.inputmask("+7(999)999-99-99"))}var a;t(e)}function d(e){function d(e){switch(e.type){case"password-strength":return new a(e);case"password-show":return new t(e);case"date":return new n(e);case"phone":return new s(e);case"select2":return new r(e);case"mask":return new o(e);case"filesimple":return new i(e);default:throw new Error("Unfinded widget: "+e.type)}}return d(e)}return d}(),HexValidator=function(){"use strict";function e(e){function t(e){void 0!==e.events&&a.setEvents(e.events)}var a=this,n=["blur","change"];a.weight=0;var r="required";a.getClassName=function(){return r},a.setEvents=function(e){n=e},a.getEvents=function(){return n},a.isValid=function(e){return null===e||e===!1||void 0===e||""===e||$.isArray(e)&&0===e.length?!1:!0},t(e)}function t(e){function t(e){void 0!==e.events&&a.setEvents(e.events),void 0!==e.input&&(r=e.input)}var a=this,n=["change","keyup","blur"];a.weight=3;var r,i="date";a.getClassName=function(){return i},a.setEvents=function(e){n=e},a.getEvents=function(){return n},a.isValid=function(e){if(""===e||void 0===e||e===!1)return!0;var t=r.inputmask("option","mask");return Inputmask.isValid(r.val(),{alias:t})},t(e)}function a(e){function t(e){void 0!==e.events&&a.setEvents(e.events)}var a=this,n="email";a.getClassName=function(){return n};var r=["change","keyup"],i=/^\S+[@]\S+\.\S{2,10}$/i;a.weight=1,a.setEvents=function(e){r=e},a.getEvents=function(){return r},a.isValid=function(e){return""===e||void 0===e||e===!1?!0:i.test(e)},t(e)}function n(e){function t(e){void 0!==e.events&&a.setEvents(e.events),void 0!==e.url&&(r=e.url)}var a=this,n="unique";a.getClassName=function(){return n};var r,i=!1,o=!1,s=["change","keyup","blur"];a.weight=5,a.setEvents=function(e){s=e},a.getEvents=function(){return s},a.isValid=function(e){if(o!==!1&&o.abort(),i!==e){o=$.ajax({url:r,data:{value:e},method:"POST",async:!1});var t=o.responseText;return i="true"===t?e:!1,t}return!0},t(e)}function r(e){function t(e){void 0!==e.events&&n.setEvents(e.events),void 0!==e.input&&(a=e.input)}var a,n=this,r="phone",i=["blur"];n.getClassName=function(){return r},n.weight=4,n.setEvents=function(e){i=e},n.getEvents=function(){return i},n.isValid=function(e){if(""===e||void 0===e||e===!1||null===e)return!0;var t=a.inputmask("option","mask");return Inputmask.isValid(a.val(),{alias:t})},t(e)}function i(e){function t(e){void 0!==e.events&&n.setEvents(e.events),void 0!==e.input&&(a=e.input)}var a,n=this,r="mask",i=["blur"];n.getClassName=function(){return r},n.weight=4,n.setEvents=function(e){i=e},n.getEvents=function(){return i},n.isValid=function(e){if(""===e||void 0===e||e===!1||null===e)return!0;var t=a.inputmask("option","mask");return Inputmask.isValid(a.val(),{alias:t})},t(e)}function o(e){function t(e){void 0!==e.min&&(a=e.min),void 0!==e.max&&(n=e.max),void 0!==e.events&&r.setEvents(e.events)}var a,n,r=this,i="string-length";r.getClassName=function(){return i};var o=["change","keyup","blur"];r.weight=3,r.setEvents=function(e){o=e},r.getEvents=function(){return o},r.isValid=function(e){var t=e.length;return void 0!==a&&a>t?(i="string-length-min",!1):void 0!==n&&t>n?(i="string-length-max",!1):!0},t(e)}function s(e){function t(e){void 0!==e.events&&a.setEvents(e.events),void 0!==e.password&&(i=$(e.password))}var a=this,n="password-confirm";a.getClassName=function(){return n};var r=["change","keyup","blur"];a.weight=4;var i;a.setEvents=function(e){r=e},a.getEvents=function(){return r},a.isValid=function(e){return i.val()===e},t(e)}function d(d){function l(d){switch(d.type){case"required":return new e(d);case"email":return new a(d);case"unique":return new n(d);case"password-confirm":return new s(d);case"string-length":return new o(d);case"date":return new t(d);case"phone":return new r(d);case"mask":return new i(d);default:throw new Error("Unfinded validator: "+d.type)}}return l(d)}return d}(),hexForm=function(e,t){"use strict";function a(e){function t(e){return function(t,a){return"number"==typeof t[e]?t[e]-a[e]:t[e]<a[e]?-1:t[e]>a[e]?1:0}}var a=this;a.type=void 0,a.valid=!0,a.name=void 0;var n=[];a.form=e.form;var r,i;a.formGroup=void 0,a.panels=[],a.tabs=[];var o,s=[],d={},l={};a.disabled=!1,a.readonly=!1,a.setValid=function(){void 0!==a.formGroup&&a.formGroup.removeClass("has-error"),void 0!==r&&r.find("span").removeClass("active")},a.enable=function(){for(var e in n)n[e].prop("disabled",!1);a.disabled=!1},a.disable=function(){for(var e in n)n[e].prop("disabled",!0);a.disabled=!0,a.valid=!0,a.validate()},a.addReadonly=function(){for(var e in n)n[e].prop("readonly",!0);a.readonly=!0},a.removeReadonly=function(){for(var e in n)n[e].prop("readonly",!1);a.readonly=!1};var u=function(){var e=0;if(void 0!==r&&r.find("span").removeClass("active"),!a.disabled)for(var t in s)if(s.hasOwnProperty(t)){var n=s[t],i=a.getValue(),o=n.isValid(i);if(o===!1||"false"===o){e++,void 0!==r&&r.find("span.error-"+n.getClassName()).addClass("active");break}}if(e>0?(a.valid=!1,void 0!==a.formGroup&&a.formGroup.addClass("has-error")):(void 0!==a.formGroup&&a.formGroup.removeClass("has-error"),a.valid=!0),a.panels.length>0){var d=!0;if(a.valid===!0){for(var l in a.form.controls)if(a.form.controls.hasOwnProperty(l)){var u=a.form.controls[l];if(u.valid===!1)for(var c in u.panels){var f=u.panels[c];for(var v in a.panels)if(f===a.panels[v]){d=!1;break}}}}else d=!1;d===!0?$.each(a.tabs,function(e,t){t.removeClass("has-error")}):$.each(a.tabs,function(e,t){t.addClass("has-error")})}return a.valid};a.validate=function(e){return void 0===e?u():"blur"===e.type?u():(void 0!==i&&clearTimeout(i),void(i=setTimeout(u,500)))},a.trigger=function(e){for(var t=0;t<n.length;t++)n[t].trigger(e)},a.addEvent=function(e,t){for(var a=0;a<n.length;a++)n[a].bind(e,t)};var c=function(e){for(var t={},a=e[0].attributes,n=a.length,r=0;n>r;r++)t[a[r].name.toLowerCase()]=a[r].value;return t},f=function(e,t,a){var n={input:a,type:e};void 0!==t&&""!==t&&$.extend(n,jQuery.parseJSON(t));var r=new HexValidator(n),i=r.getEvents();for(var o in i)i.hasOwnProperty(o)&&(l[i[o]]=!0);s.push(r)},v=function(e,t,n){var r={input:n,type:e,control:a};void 0!==t&&""!==t&&$.extend(r,jQuery.parseJSON(t)),d[e]=new HexWidget(r)};a.addInput=function(e){n.push(e);var r=c(e);for(var i in r)if(r.hasOwnProperty(i)){if("required"===i)f("required",r[i],e);else{var o=i.match(/^data-hex-validator-(.*)$/i);null!==o&&void 0!==o[1]&&f(o[1],r[i],e)}var d=i.match(/^data-hex-widget-(.*)$/i);null!==d&&void 0!==d[1]&&v(d[1],r[i],e)}for(var u in l)l.hasOwnProperty(u)&&e.bind(u,a.validate);s.sort(t("weight")),e.prop("disabled")&&a.disable(),e.prop("readonly")&&a.addReadonly(),e.bind("disable",function(){a.disable()}),e.bind("enable",function(){a.enable()})},a.getValue=function(){switch(a.type){case"text":default:if(void 0!==d.date){var e=n[0].data("daterangepicker");if(void 0===e)return n[0].val();if(""===n[0].val())return!1;var t="",r="YYYY-MM-DD";if(e.timePicker===!0&&(r+=" HH:mm"),t+=e.startDate.format(r),e.singleDatePicker===!1){var i=e.endDate.format(r);t+=" - "+i}return t}return void 0!==d.fileupload||void 0!==d.filesimple?o:n[0].val();case"radio":for(var s in n)if(n.hasOwnProperty(s)&&n[s].is(":checked")===!0)return n[s].val();return!1;case"checkbox":return n[0].is(":checked")===!0?a.trueValue:a.falseValue}},a.setValue=function(e){o=e};var p=function(e){if(void 0!==e.type&&(a.type=e.type,"checkbox"===e.type&&(a.trueValue=!0,a.falseValue=!1)),void 0!==e.form&&(a.form=e.form),a.name=e.name,void 0!==e.inputs)for(var t in e.inputs)e.inputs.hasOwnProperty(t)&&a.addInput(e.inputs[t]);a.formGroup=n[0].closest("div.form-group"),0===a.formGroup.size()?a.formGroup=void 0:(r=a.formGroup.find(".errors"),0===r.size()&&(r=void 0)),n[0].parents('[role="tabpanel"]').size()>0&&n[0].parents('[role="tabpanel"]').each(function(){var e=$(this),t=e.attr("id");a.panels.push(t);var n=$('.nav a[href="#'+t+'"]');n.size()>0&&a.tabs.push(n)}),a.setValid()};p(e)}function n(n){function r(e){function t(){var t=r.getValue(),a=!1;null===t||t===!1||void 0===t||""===t||$.isArray(t)&&0===t.length?a=!1:("string"==typeof t&&t===n&&(a=!0),"object"==typeof t&&t.indexOf(n)>=0&&(a=!0)),a?(e.show(),e.find('input[type!="submit"],select,textarea').trigger("enable")):(e.hide(),e.find('input[type!="submit"],select,textarea').trigger("disable"))}if(e.parents('[data-hex-multy-item="$"]').size()>0)return!1;var a=e.data("hexDisabled"),n=a.value,r=s.controls[a.control];if(void 0===r)throw new Error('Control "'+a.control+'" not found');r.addEvent("change",t),r.trigger("change")}function i(e){return e.replace("-","").toUpperCase()}function o(e){function t(e,t){s.hexBind(e,{"@index":t})}function a(){if(d===!1){var t=e.find("[data-hex-multy-item]");t.size()<=1?e.find("[data-hex-multy-remove]").attr("disabled","disabled"):e.find("[data-hex-multy-remove]").removeAttr("disabled")}}var n,i,o=e.data("hex-multy"),d=!1;void 0!==o.allow_empty&&o.allow_empty===!0&&(d=!0),e.find("[data-hex-multy-tabs]").size()>0&&(n=e.find("[data-hex-multy-tabs]"),i=n.find('[data-hex-multy-tab="$"]').clone(!1),n.find('[data-hex-multy-tab="$"]').remove());var l=e.find('[data-hex-multy-item="$"]'),u=l.clone(!1);l.remove(),e.on("click","[data-hex-multy-add]",function(){var o=$(this).closest("[data-hex-multy]").find("[data-hex-multy-item]"),s=o.size(),d=u.clone(!1);if(d.find("[data-hex-multy-hide]").remove(),d.find("[data-hex-multy-attr]").each(function(){var e=$(this),t=e.data("hex-multy-attr");if(void 0!==t.add&&$.each(t.add,function(t,a){for(var n in a)e.attr(n,a[n])}),void 0!==t.remove)for(var a in t.remove)e.removeAttr(t.remove[a])}),t(d,s),d.appendTo(e.find("[data-hex-multy-items]")),void 0!==n){var l=i.clone(!1);t(l,s),e.find("[data-hex-multy-tab]:last").size()>0?l.insertAfter(e.find("[data-hex-multy-tab]:last")):n.prepend(l)}f(d),void 0!==n&&$('a[href="#'+d.attr("id")+'"]').trigger("click"),d.find("[data-hex-disabled]").size()>0&&d.find("[data-hex-disabled]").each(function(){r($(this))}),a()}),e.on("click","[data-hex-multy-remove]",function(){var r=$(this).closest("[data-hex-multy-item]"),i=r.data("hexMultyItem"),o=e.find("[data-hex-multy-item]");c(r),r.fadeOut(500,function(){r.remove(),o.each(function(){$(this).data("hexMultyItem")>i&&t($(this),$(this).data("hexMultyItem")-1)}),void 0!==n&&(n.find('[data-hex-multy-tab="'+i+'"]').remove(),n.find("[data-hex-multy-tab]").each(function(){$(this).data("hexMultyTab")>i&&t($(this),$(this).data("hexMultyTab")-1)}),n.find("[data-hex-multy-tab="+i+"]").size()>0?n.find("[data-hex-multy-tab="+i+"]").find('a[role="tab"]').trigger("click"):n.find("[data-hex-multy-tab]:nth-child("+i+")").size()>0&&n.find("[data-hex-multy-tab]:nth-child("+i+")").find('a[role="tab"]').trigger("click")),a()})}),a()}var s=this;s.controls={},s.errorText="Не удалось сохранить форму, попробуйте обновить страницу",s.invalidText="Форма содержит ошибки";var d=$("#"+n),l={},u=function(e){this.type=e,this.stoped=!1,this.stop=function(){this.stoped=!0}};s.on=function(e,t){void 0===l[e]&&(l[e]=[]),l[e].push(t)},s.off=function(e,t){void 0!==l[e]&&l[e].splice(l[e].indexOf(t),1)},s.fire=function(e,t){var a=new u(e);if(void 0!==l[e])for(var n in l[e]){var r=l[e][n];r(t,a)}return!a.stoped};var c=function(e){$.each(e.find('input[type!="submit"],select,textarea'),function(e,t){var a=$(t),n=a.attr("name");void 0!==s.controls[n]&&delete s.controls[n]})},f=function(e){$.each(e.find('input[type!="submit"],select,textarea'),function(e,t){var n=$(t);if(0===n.parents('[data-hex-multy-item="$"]').size()){var r=n.attr("name"),i=n.prop("tagName").toLowerCase();switch(i){case"select":case"textarea":s.controls[r]=new a({type:i,inputs:[n],form:s,name:r});break;case"input":var o=n.attr("type").toLowerCase();switch(o){default:s.controls[r]=new a({type:o,inputs:[n],form:s,name:r});break;case"checkbox":var d=new a({type:"checkbox",inputs:[n],form:s,name:r});void 0!==n.attr("value")&&(d.trueValue=n.attr("value")),void 0!==n.attr("data-hex-true-value")&&(d.trueValue=n.attr("data-hex-true-value")),void 0!==n.attr("data-hex-false-value")&&(d.falseValue=n.attr("data-hex-false-value")),s.controls[r]=d;break;case"radio":void 0===s.controls[r]?s.controls[r]=new a({type:"radio",inputs:[n],form:s,name:r}):s.controls[r].addInput(n)}}}})},v=function(){var e={};for(var t in s.controls)if(s.controls.hasOwnProperty(t)&&s.controls[t].disabled===!1){var a=s.controls[t].name,n=s.controls[t].getValue();null===n||$.isArray(n)&&0===n.length?n="":e[a]=n}return e},p=function(t){var a=s.fire("beforeReset",{values:s.getValues()});a?e.setTimeout(function(){for(var e in s.controls)s.controls.hasOwnProperty(e)&&s.controls[e].trigger("change")},1):t.preventDefault(),s.fire("afterReset",{})},h=function(){d.find(".has-error").removeClass("has-error"),d.find(".alerts div").remove()},m=function(t){t.preventDefault(),t.stopPropagation();var a=!0;for(var n in s.controls)s.controls.hasOwnProperty(n)&&s.controls[n].validate(void 0)===!1&&(a=!1);if(a===!0){h();var r=v(),i=s.fire("beforeSubmit",{values:r});if(i){s.loaderShow();var o=d.attr("action"),l=d.find("button[type=submit]:focus");l.size()>0&&void 0!==l.attr("data-action")&&(o=l.attr("data-action"));var u="POST";void 0!==d.attr("method")&&(u=d.attr("method"));var c=new FormData;$.each(r,function(e,t){if($.isArray(t)||$.isPlainObject(t))for(var a in t)null!==t[a]&&t[a]!==!1&&void 0!==t[a]&&c.append(e,t[a]);else c.append(e,t)}),$.ajax({url:o,data:c,type:u,dataType:"json",processData:!1,contentType:!1,success:function(t){var a=s.fire("afterSubmit",t);if(a&&(t.success===!0?(h(),void 0!==t.reload?t.reload===!0?e.location.href=e.location.href:e.location.href=t.reload:s.loaderHide()):s.loaderHide(),void 0!==t.alerts)){for(var n in t.alerts){var r=t.alerts[n];d.find(".alerts").append($("<div>").addClass("alert alert-"+r.type).html(r.text))}s.loaderHide()}},error:function(e,t){s.loaderHide(),d.find(".alerts").append($("<div>").addClass("alert alert-danger").html(s.errorText))}})}}else d.find(".alerts div").remove(),d.find(".alerts").append($("<div>").addClass("alert alert-danger").html(s.invalidText));return!1};s.loaderShow=function(){d.find(".loader").show()},s.loaderHide=function(){d.find(".loader").hide()},s.submit=function(){m()},s.getValues=function(){return v()},s.hexBind=function(e,t){function a(e){var t=e.split(""),a=[],n=[],r=0,i=!0;a[r]="";for(var o=0;o<t.length;o++)isNaN(parseInt(t[o]))&&"."!==t[o]&&!i?(n[r]=t[o],r++,a[r]="",i=!0):(a[r]+=t[o],i=!1);e=parseFloat(a[0]);for(var s=0;s<n.length;s++){var d=parseFloat(a[s+1]);switch(n[s]){case"+":e+=d;break;case"-":e-=d;break;case"*":e*=d;break;case"/":e/=d}}return e}function n(e){if("object"==typeof e)for(var r in e)e[r]=n(e[r]);else{for(var i in t)e=e.replace(new RegExp(i,"g"),t[i]);/\%/.test(e)&&(e=e.replace(/\%(.*?)\%/g,function(e){return a(e.replace(/\%/g,""))}))}return e}var r=[];r.push(e),e.find("[data-hex-bind]").each(function(){r.push($(this))});for(var o in r){var d=r[o].data("hexBind");for(var l in d){var u=n(d[l]);if(u!==d[l])if("html"!==l){if(/^data/.test(l)){var c=l.replace(/^data-/,"");c=c.replace(/(\-[a-z])/g,i),r[o].data(c,u)}if("name"===l){var f=r[o].attr("name");if(void 0!==f&&void 0!==s.controls[f]){var v=s.controls[f];v.name=u,s.controls[u]=v,delete s.controls[f]}}"object"==typeof u?r[o].attr(l,JSON.stringify(u)):r[o].attr(l,u)}else r[o].html(u)}}};var g=function(){d.addClass("loader-container").append('<div class="loader"></div>'),$(t).on("submit","#"+n,m),$(t).on("reset","#"+n,p),0===d.find(".loader").size()&&d.append('<div class="loader"></div>'),f(d),d.find("[data-hex-multy]").size()>0&&d.find("[data-hex-multy]").each(function(){o($(this))}),d.find("[data-hex-disabled]").size()>0&&d.find("[data-hex-disabled]").each(function(){r($(this))})};return g(),s}function r(e){if(void 0!==e)return void 0===i[e]&&(i[e]=new n(e)),i[e];var t=$("form.hex-form");return t.each(function(){var e=$(this).attr("id");if(void 0===e)throw new Error("Form dont have id attr");i[e]=new n(e)}),i}var i={};return r}(window,document);